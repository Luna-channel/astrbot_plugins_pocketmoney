# 小金库插件 (PocketMoney)

贝塔的小金库+存折系统，一个为AstrBot设计的全局资金管理插件。

## 版本历史

| 版本 | 功能 |
|------|------|
| v1.0 | 基础零花钱：余额管理、入账/出账、记录查询 |
| v1.1 | 表扬信/投诉信系统：每日限制、排行榜、随机奖金 |
| v1.2 | 背包系统：共享背包、物品入库/使用 |
| v1.3 | 专属背包格子：每个用户独立的礼物存储空间 |
| v1.4 | 笔记功能：AI私密备忘录，管理员可查看/追加 |
| v1.5 | 数据目录迁移至plugin_data，记录操作窗口source替代operator |
| v1.6 | 今日花销统计、压岁钱功能（新年特别版） |
| v1.7 | 代码重构：删除压岁钱、合并存折到小金库、用户隔离池 |

## 功能特点

- **全局余额管理**：不区分会话，所有窗口共享同一个钱包
- **存折系统**：更安全的存储，取款需要管理员审批
- **入账控制**：只有管理员（奥卢斯大人）可以通过指令入账
- **AI自主出账**：AI可以在对话中自主决定花钱（有余额不足保底策略）
- **交易记录**：保存完整的入账/出账记录
- **上下文注入**：自动将小金库状态注入到对话上下文中
- **表扬信系统**：用户发送表扬信可获得随机奖金（每人每天一次）
- **投诉信系统**：用户可发送投诉信，自动转发给管理员（含来源窗口信息）
- **共享背包系统**：AI可自主管理私人物品，存取自己的东西
- **用户专属格子**：每个用户有3个独立的专属格子（跨窗口），用于存放收到的礼物
- **私密笔记**：AI可写入私密备忘录，仅管理员可查看
- **今日花销**：自动统计当天从凌晨0点开始的花销总额

## 管理员指令

| 指令 | 说明 | 示例 |
|------|------|------|
| `发零花钱 <金额> [原因]` | 入账 | `发零花钱 200 每周零花钱` |
| `扣零花钱 <金额> [原因]` | 扣款 | `扣零花钱 50 罚款` |
| `设置余额 <金额> [原因]` | 直接设置余额 | `设置余额 1000 初始化` |
| `查账` | 查看余额和最近记录 | `查账` |
| `查流水 [数量]` | 查看交易流水 | `查流水 20` |
| `清空流水` | 清空交易记录（保留余额） | `清空流水` |
| `存折存入 <金额> [原因]` | 存入存折 | `存折存入 100 存起来` |
| `查看存折` | 查看存折余额和待审批数量 | `查看存折` |
| `待审批列表` | 查看待审批的取款申请 | `待审批列表` |
| `批准取款 <申请ID>` | 批准取款申请 | `批准取款 1234567890123` |
| `拒绝取款 <申请ID> [原因]` | 拒绝取款申请 | `拒绝取款 1234567890123 不批` |
| `查看背包` | 查看贝塔的共享背包 | `查看背包` |
| `查看专属格子 [用户ID]` | 查看用户专属格子 | `查看专属格子 12345` |
| `清空背包` | 清空共享背包所有物品 | `清空背包` |
| `清空专属格子 <用户ID>` | 清空指定用户的专属格子 | `清空专属格子 12345` |
| `背包移除 <物品名>` | 从共享背包移除物品 | `背包移除 小蛋糕` |
| `专属格子移除 <用户ID> <物品名>` | 从用户专属格子移除物品 | `专属格子移除 12345 小花` |
| `查看笔记` | 查看贝塔的私密笔记 | `查看笔记` |
| `追加笔记 <内容>` | 追加内容到笔记 | `追加笔记 记得还小明5块钱` |
| `清空笔记` | 清空贝塔的笔记 | `清空笔记` |
| `零花钱拉黑 <用户ID>` | 将用户加入黑名单 | `零花钱拉黑 12345` |
| `零花钱解除拉黑 <用户ID>` | 将用户移出黑名单 | `零花钱解除拉黑 12345` |
| `零花钱黑名单` | 查看黑名单列表 | `零花钱黑名单` |
| `零花钱隔离池 <用户ID>` | 查看用户隔离池数据 | `零花钱隔离池 12345` |

## 用户指令

| 指令 | 说明 | 示例 |
|------|------|------|
| `发表扬信` | 发送表扬信获得随机奖金（每天一次） | `发表扬信` |
| `发投诉信 [理由]` | 发送投诉信给管理员 | `发投诉信 贝塔不理我` |
| `表扬信排行 [数量]` | 查看表扬信排行榜 | `表扬信排行 10` |
| `今日表扬` | 查看今日表扬奖金统计 | `今日表扬` |
| `零花钱日期` | 查看距离发零花钱还有几天 | `零花钱日期` |
| `我的格子` | 查看自己在贝塔这里的专属格子 | `我的格子` |

## AI自动标记

### 出账标记
当AI决定花钱时，会在回复末尾添加：
```
[Spend: 50, Reason: 请群友喝奶茶]
```

### 共享背包入库标记
当AI给自己买了东西时，会在回复末尾添加：
```
[Store: 小蛋糕, Desc: 草莓味的，留着饿了吃]
```

### 共享背包使用标记
当AI想用掉共享背包里的东西时，会在回复末尾添加：
```
[Use: 小蛋糕]
```

### 礼物入库标记
当AI收到别人送的礼物时，会在回复末尾添加：
```
[Gift: 小花, From: 小明, Desc: 红色的玫瑰花]
```

### 使用礼物标记
当AI想用掉专属格子里的礼物时，会在回复末尾添加：
```
[UseGift: 小花]
```

### 退款标记
当AI发现之前标错了价格需要退款时，会在回复末尾添加：
```
[Refund: 5, Reason: 之前标错价格了]
```

### 笔记标记
当AI想记录一些私密备忘时，会在回复末尾添加（会覆盖旧笔记）：
```
[Note: 答应奥卢斯大人不再乱花钱了]
```

插件会自动解析并执行相应操作，同时从回复中移除这些标记。

### 申请取款标记
当AI需要从存折取款时，会在回复末尾添加：
```
[ApplyWithdraw: 50, Reason: 需要买材料]
```

## 配置项

在AstrBot管理面板中可配置：

- **initial_balance**: 初始余额（默认0）
- **max_shared_slots**: 共享背包格子上限（默认10）
- **max_user_slots**: 用户专属格子上限（默认3）
- **thank_letter_min_amount**: 表扬信最小奖金（默认1）
- **thank_letter_max_amount**: 表扬信最大奖金（默认10）
- **admin_qq**: 管理员QQ号（投诉信/取款申请通知目标）
- **admin_permission_denied_msg**: 非管理员权限提示
- **max_records**: 最大记录条数（默认100）
- **income_record_count**: 注入提示词的入账记录条数
- **expense_record_count**: 注入提示词的出账记录条数
- **allowance_day**: 发零花钱的星期（1-7）
- **pocketmoney_prompt**: 小金库+存折系统提示词模板
- **backpack_prompt**: 小背包系统提示词模板
- **max_note_entries**: 笔记保留条数（默认5）
- **debug_log_level**: 日志级别
- **blacklist_users**: 黑名单用户QQ号列表（也可通过指令动态管理）

## 数据存储

插件数据存储在 `data/plugin_data/astrbot_plugin_pocketmoney/` 目录下：
- `pocket_money.json` - 余额、存折、交易记录和笔记
- `thank_letters.json` - 表扬信数据和排行榜
- `backpack.json` - 小背包物品
- `blacklist.json` - 黑名单用户列表
- `isolation/` - 黑名单用户的隔离数据目录

## 安装

将插件文件夹放入AstrBot的plugins目录，重启AstrBot即可。

## 作者

柯尔


#### 交流群

插件反馈群：🐧 **鸭 strbot** (QQ群: 1080426640) 记得给鸭点小星星再申请。
